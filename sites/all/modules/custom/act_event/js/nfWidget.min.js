/*
 * OTI nfWidget JavaScript File
 * http://www.oldtownit.com
 *
 * Copyright (c)2012, Old Town IT, LLC
 *
 */
(function ($) {
    function appendUrlParams(a, b) {
        var c = a.indexOf("?") == -1 ? a : a.substring(0, a.indexOf("?"));
        var d = a.indexOf("?") == -1 ? "" : a.substring(a.indexOf("?") + 1);
        var e = getUrlParams(d);
        if (e.webkey && b.webcode) delete e.webkey;
        if (e.webcode && b.webkey) delete e.webcode;
        $.extend(e, b);
        $.each(e, function (a, b) {
            c += (c.indexOf("?") == -1 ? "?" : "&") + a + "=" + b
        });
        return c
    }

    function appendNfWidgetId(a, b) {
        return a += (a.indexOf("?") == -1 ? "?" : "&") + "nfWidgetId=" + b
    }

    function getUrlParams(a) {
        var b = {};
        (function () {
            var c, d = /\+/g, e = /([^&=]+)=?([^&]*)/g, f = function (a) {
                return a
            }, g = a;
            while (c = e.exec(g)) {
                b[f(c[1].toLowerCase())] = f(c[2])
            }
        })();
        return b
    }

    function updateIFrame(a) {
        $("#nfWidget").css("height", parseInt(a) + "px")
    }

    function getRelaxDomainValueFromHost(a) {
        var b = a;
        var c = new Array;
        c = b.split(".");
        var d = 0;
        if (c.length > 2) {
            d = c.length - 2;
            b = c[d];
            b += "." + c[d + 1]
        }
        return b
    }

    function parseUri(a) {
        var b = parseUri.options, c = b.parser[b.strictMode ? "strict" : "loose"].exec(a), d = {}, e = 14;
        while (e--) d[b.key[e]] = c[e] || "";
        d[b.q.name] = {};
        d[b.key[12]].replace(b.q.parser, function (a, c, e) {
            if (c) d[b.q.name][c] = e
        });
        return d
    }

    function parentScrollTopPosition() {
        return Math.max($(parent.window).scrollTop(), parent.document.documentElement.scrollTop)
    }

    function parentScrollLeftPosition() {
        return Math.max($(parent.window).scrollLeft(), parent.document.documentElement.scrollLeft)
    }

    function passSslFromParent(a, b, c) {
        if (a && b == "https") {
            if (c.match(/^http:\/\//i)) {
                c = c.replace(/^http:\/\//i, "https://")
            }
        }
        return c
    }

    function getDialogTop(a) {
        var b = $(parent.window).height();
        var c = a.height();
        var d = (b - c) / 2;
        var e = 0;
        if (parent.document != document) {
            e = parent.$("iframe[src='" + document.location + "']").offset().top
        }
        d = d - e + parentScrollTopPosition();
        return d
    }

    function getDialogLeft(a) {
        var b = $(parent.window).width();
        var c = a.width();
        var d = (b - c) / 2;
        var e = 0;
        if (parent.document != document) {
            e = parent.$("iframe[src='" + document.location + "']").offset().left
        }
        d = d - e + parentScrollLeftPosition();
        return d
    }

    if (typeof jQuery != "undefined") {
        (function (a) {
            var b = { init: function (b) {
                var c = { title: "OTI nfWidget", frameborder: "0", scrolling: "no", width: "100%", height: "600px", iframeId: "nfWidgetFrame", src: "http://www.oldtownit.com", noFramesText: "The current browser does not support Web pages that contain the IFRAME element. To use this application, you must use a browser that supports this element, such as Internet Explorer version 5 or later.", passQueryStringParams: true, domainRelaxingEnabled: true, passSslFromParent: true };
                if (c.domainRelaxingEnabled) {
                    try {
                        document.domain = getRelaxDomainValueFromHost(parseUri(document.domain).host)
                    } catch (d) {
                    }
                }
                return this.each(function () {
                    if (b) {
                        a.extend(c, b)
                    }
                    var d = a(this);
                    if (d) {
                        d.css("width", c.width);
                        d.css("height", c.height);
                        if (c.passQueryStringParams) {
                            c.src = appendUrlParams(c.src, getUrlParams(window.location.search.substring(1)))
                        }
                        var e = parseUri(location).protocol;
                        c.src = passSslFromParent(c.passSslFromParent, e, c.src);
                        c.src = appendNfWidgetId(c.src, d.attr("id"));
                        c.src += "&protocol=" + e;
                        var f = a("<iframe name='" + c.iframeId + "' id='" + c.iframeId + "'>" + c.noFramesText + "</iframe>");
                        f.attr("title", c.title);
                        f.attr("frameborder", c.frameborder);
                        f.attr("scrolling", c.scrolling);
                        f.attr("width", "100%");
                        f.attr("height", "100%");
                        f.attr("src", c.src);
                        d.append(f)
                    }
                })
            }, resize: function (a) {
            }, centerDialog: function () {
                var b = this;
                b.each(function () {
                    var b = a(this);
                    if (b) {
                        var c = b.dialog("widget");
                        b.dialog("option", "position", [getDialogLeft(c), getDialogTop(c)])
                    }
                });
                return b
            } };
            a.fn.nfWidget = function (c) {
                if (b[c]) {
                    return b[c].apply(this, Array.prototype.slice.call(arguments, 1))
                } else if (typeof c === "object" || !c) {
                    return b.init.apply(this, arguments)
                } else {
                    a.error("Method " + c + " does not exist on nfWidget")
                }
            }
        })(jQuery)
    } else {
        var errorDiv = document.createElement("div");
        errorDiv.innerText = "jQuery is required for OTI nfWidget. Please make sure it is being loaded on the page and try again.";
        document.body.insertBefore(errorDiv, document.body.firstChild)
    }
    parseUri.options = { strictMode: false, key: ["source", "protocol", "authority", "userInfo", "user", "password", "host", "port", "relative", "path", "directory", "file", "query", "anchor"], q: { name: "queryKey", parser: /(?:^|&)([^&=]*)=?([^&]*)/g }, parser: { strict: /^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/, loose: /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/} }
})(jQuery);
